<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EuroDash — M-Theme Simulation (C)</title>
<style>
  :root{
    --m-cyan:#00bcd4;
    --m-mag:#8a2be2;
    --m-red:#ff3b3b;
    --bg:#05060a;
    --panel:#07080b;
    --glass: rgba(255,255,255,0.02);
    --muted: rgba(255,255,255,0.65);
    --accent1: var(--m-cyan);
    --accent2: var(--m-mag);
    --accent3: var(--m-red);
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,Orbitron,Segoe UI,Roboto, sans-serif;color:var(--m-cyan);-webkit-font-smoothing:antialiased;}
  body::before{
    content:"";position:fixed;inset:0;background:
    linear-gradient(135deg, rgba(255,255,255,0.01) 0 1px, transparent 1px),
    linear-gradient(45deg, rgba(255,255,255,0.008) 0 1px, transparent 1px);
    background-size:8px 8px,8px 8px;opacity:0.04;pointer-events:none;
  }

  .ic10-wrap{
    width:1200px;height:800px;margin:20px auto;border-radius:14px;
    border:8px solid rgba(0,188,212,0.06);box-shadow:0 24px 60px rgba(0,0,0,0.8), inset 0 0 40px rgba(0,188,212,0.02);
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.12));
    position:relative;overflow:hidden;display:flex;flex-direction:column;padding:16px;
  }

  .watermark{position:absolute;right:18px;bottom:14px;font-size:28px;opacity:0.04;transform:rotate(-12deg);font-weight:700;letter-spacing:6px;color:var(--m-mag);pointer-events:none;}

  .topbar{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;}
  .left-top{display:flex;gap:12px;align-items:center;}
  .clock{font-size:14px;color:var(--muted);padding:6px 10px;background:var(--glass);border-radius:6px;}
  .mode-toggle{display:flex;gap:8px;align-items:center;}
  .toggle-btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--m-cyan);cursor:pointer}
  .toggle-btn.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001020;box-shadow:0 8px 28px rgba(138,43,226,0.08)}

  .main{display:flex;flex:1;gap:18px;padding:10px;}

  .left-col{width:620px;background:linear-gradient(180deg,#061016, #07060a);border-radius:10px;padding:12px;display:flex;flex-direction:column;align-items:center;position:relative;border:1px solid rgba(255,255,255,0.03)}
  .rpm-container{width:520px;height:300px;position:relative;display:flex;align-items:center;justify-content:center;}
  .rpm-svg{width:520px;height:300px}
  .rpm-center{position:absolute;bottom:18px;text-align:center;color:var(--m-cyan)}
  .rpm-value{font-size:40px;font-weight:900}
  .rpm-label{font-size:12px;color:var(--muted);margin-top:6px}

  .shift-lights{position:absolute;top:14px;display:flex;gap:6px;z-index:8}
  .shift-light{width:18px;height:54px;background:rgba(255,255,255,0.04);border-radius:4px;box-shadow:inset 0 -6px 20px rgba(0,0,0,0.4);transition:all 0.06s ease;}
  .shift-light.on{background:linear-gradient(180deg,#fff,var(--accent3));box-shadow:0 8px 26px rgba(255,59,59,0.18);transform:translateY(-6px)}

  .drive-tiles{display:flex;gap:10px;margin-top:14px}
  .tile{padding:12px 18px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;min-width:110px;text-align:center;color:var(--muted)}
  .tile .name{font-weight:800}
  .tile .sub{font-size:12px;color:var(--muted)}
  .tile.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001020;box-shadow:0 12px 40px rgba(0,188,212,0.06)}

  .right-col{flex:1;background: linear-gradient(180deg,#02060a,#071014);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:12px;border:1px solid rgba(255,255,255,0.02);min-width:560px}
  .metrics-grid{display:flex;flex-wrap:wrap;gap:10px;align-items:stretch}
  .metric-box{flex:1 0 140px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);text-align:center}
  .metric-label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .metric-value{font-size:20px;font-weight:800;color:var(--m-cyan)}
  .metric-value.warn{color:var(--m-red)}
  .metric-slant{font-size:11px;color:var(--muted);margin-top:6px}

  .hbar{height:10px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden;margin-top:8px}
  .hbar > .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));transition:width 0.08s linear}

  .small-graphs{display:flex;gap:12px;align-items:flex-end;height:120px;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:8px}
  .graph-col{flex:1;background:transparent;padding:6px;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:flex-end}
  .graph-bar{width:48px;border-radius:6px;background:linear-gradient(180deg,#111,#070707);height:6px;display:flex;align-items:flex-end;overflow:hidden;box-shadow:inset 0 -8px 18px rgba(0,0,0,0.6)}
  .graph-fill{width:100%;height:0%;background:linear-gradient(180deg,var(--accent3),var(--accent2));transition:height 0.12s linear}

  .log-controls{display:flex;gap:12px;align-items:center}
  .record-btn{padding:10px 14px;border-radius:8px;background:#111;border:1px solid rgba(255,0,0,0.12);color:var(--accent3);cursor:pointer}
  .record-btn.rec{background:var(--accent3);color:#fff;box-shadow:0 6px 18px rgba(255,59,59,0.12)}
  .download-link{color:var(--m-cyan);text-decoration:underline;cursor:pointer;font-size:13px}

  .log-list{max-height:140px;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;font-size:12px;color:var(--muted);}

  .small-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  .mode-pill{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);cursor:pointer}
  .mode-pill.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001020}

  /* G-force circle & other modules */
  .modules{display:flex;gap:12px;align-items:center;margin-top:6px}
  .gforce{width:140px;height:140px;border-radius:50%;border:2px solid rgba(255,255,255,0.02);position:relative;display:flex;align-items:center;justify-content:center}
  .g-dot{width:10px;height:10px;border-radius:50%;background:var(--accent3);box-shadow:0 6px 18px rgba(255,59,59,0.12);position:absolute;left:65px;top:65px;transition:transform 0.08s}
  .tire-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;width:200px}
  .tire-box{height:52px;border-radius:8px;background:linear-gradient(90deg,#111,#0a0a0a);display:flex;align-items:center;justify-content:center;color:var(--muted)}
  .brake-dot{width:46px;height:46px;border-radius:50%;background:#111;box-shadow:inset 0 -8px 20px rgba(0,0,0,0.6), 0 0 0 rgba(0,0,0,0);transition:box-shadow 0.12s}

  .map-popup{position:absolute;right:18px;top:90px;width:420px;height:260px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.35));border-radius:10px;padding:8px;display:none;border:1px solid rgba(255,255,255,0.02)}

  /* startup animation */
  .startup{position:absolute;inset:0;background:radial-gradient(circle at 30% 20%, rgba(0,188,212,0.08), transparent 20%), linear-gradient(180deg, rgba(0,0,0,0.9), transparent 40%);display:flex;align-items:center;justify-content:center;z-index:1000;font-size:48px;color:var(--m-cyan);font-weight:900;pointer-events:none;animation:fadeOut 2.4s ease forwards;}
  @keyframes fadeOut{0%{opacity:1}70%{opacity:1}100%{opacity:0;visibility:hidden}}

  @media (max-width:1250px){.ic10-wrap{transform:scale(0.92)}}
</style>
</head>
<body>
<div class="ic10-wrap" id="icWrap">
  <div class="startup" id="startup">EURO DRIVE</div>
  <div class="watermark">EURO DRIVE</div>

  <div class="topbar">
    <div class="left-top">
      <div class="clock" id="clock">Mon 00:00:00</div>
      <div class="toggle-btn" id="nightToggle">Night Mode</div>
      <div class="toggle-btn" id="trackToggle">Track Mode</div>
      <div class="toggle-btn" id="driftToggle">Drift Mode</div>
    </div>
    <div class="mode-toggle">
      <div style="font-size:13px;color:var(--muted);margin-right:8px">Boost / Antilag</div>
      <button class="toggle-btn" id="lowBoost">LOW BOOST</button>
      <button class="toggle-btn" id="highBoost">HIGH BOOST</button>
      <button class="toggle-btn" id="antilagBtn">ANTILAG</button>
    </div>
  </div>

  <div class="main">
    <!-- LEFT: RPM, shift lights, drive tiles -->
    <div class="left-col">
      <div class="shift-lights" id="shiftLights" style="left:calc(50% - 80px)">
        <div class="shift-light" data-idx="1"></div>
        <div class="shift-light" data-idx="2"></div>
        <div class="shift-light" data-idx="3"></div>
        <div class="shift-light" data-idx="4"></div>
        <div class="shift-light" data-idx="5"></div>
        <div class="shift-light" data-idx="6"></div>
        <div class="shift-light" data-idx="7"></div>
        <div class="shift-light" data-idx="8"></div>
      </div>

      <!-- SVG RPM arc for smoother visuals -->
      <div class="rpm-container">
        <svg class="rpm-svg" viewBox="0 0 520 300" preserveAspectRatio="xMidYMid meet">
          <defs>
            <linearGradient id="gM" x1="0%" x2="100%">
              <stop offset="0%" stop-color="var(--accent1)"/>
              <stop offset="50%" stop-color="var(--accent2)"/>
              <stop offset="100%" stop-color="var(--accent3)"/>
            </linearGradient>
          </defs>

          <!-- Background semicircle ticks -->
          <g id="ticks"></g>

          <!-- arc bg -->
          <path id="arcBg" d="" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="18" stroke-linecap="round"/>
          <path id="arc" d="" fill="none" stroke="url(#gM)" stroke-width="18" stroke-linecap="round"/>

          <!-- Needle -->
          <g id="needleGroup" style="transform-origin:260px 260px;">
            <line id="needle" x1="260" y1="260" x2="260" y2="80" stroke="#fff" stroke-width="4" stroke-linecap="round" />
            <circle cx="260" cy="260" r="10" fill="#fff"/>
          </g>
        </svg>

        <div class="rpm-center">
          <div class="rpm-value" id="rpmVal">0</div>
          <div class="rpm-label">RPM</div>
        </div>
      </div>

      <div class="drive-tiles" id="driveTiles" style="margin-top:12px">
        <div class="tile active" data-mode="comfort"><div class="name">Comfort</div><div class="sub">Smooth</div></div>
        <div class="tile" data-mode="sport"><div class="name">Sport</div><div class="sub">Sharpened</div></div>
        <div class="tile" data-mode="sportp"><div class="name">Sport+</div><div class="sub">Aggressive</div></div>
      </div>

      <div style="margin-top:10px;width:100%;display:flex;justify-content:space-between;align-items:center">
        <div class="log-controls">
          <button class="record-btn" id="startLog">Start Log</button>
          <button class="record-btn" id="endLog" disabled>End Log</button>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:13px">
          <div>Session</div>
          <div id="sessionState">Idle</div>
        </div>
      </div>

      <div style="margin-top:10px;width:100%">
        <div class="log-list" id="logList">No logs yet.</div>
      </div>
    </div>

    <!-- RIGHT: metrics, graphs, modules -->
    <div class="right-col">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:16px;font-weight:700">Telemetry</div>
        <div style="font-size:13px;color:var(--muted)">IC10 • M-Theme</div>
      </div>

      <div class="metrics-grid" id="metricsGrid">
        <div class="metric-box"><div class="metric-label">Speed</div><div class="metric-value" id="speedVal">0 MPH</div><div class="metric-slant">km/h: <span id="kph">0</span></div></div>

        <div class="metric-box"><div class="metric-label">Boost</div><div class="metric-value" id="boostVal">0 PSI</div>
          <div class="hbar"><div class="fill" id="boostBar"></div></div>
        </div>

        <div class="metric-box"><div class="metric-label">Throttle</div><div class="metric-value" id="throttleVal">0%</div>
          <div class="hbar"><div class="fill" id="throttleBar"></div></div>
        </div>

        <div class="metric-box"><div class="metric-label">Coolant Temp</div><div class="metric-value" id="coolantVal">0°C</div></div>

        <div class="metric-box"><div class="metric-label">Oil Temp</div><div class="metric-value" id="oilTempVal">0°C</div></div>

        <div class="metric-box"><div class="metric-label">IAT</div><div class="metric-value" id="iatVal">0°C</div></div>

        <div class="metric-box"><div class="metric-label">Gear</div><div class="metric-value" id="gearVal">N</div></div>
        <div class="metric-box"><div class="metric-label">AFR</div><div class="metric-value" id="afrVal">14.7</div></div>
        <div class="metric-box"><div class="metric-label">MAF</div><div class="metric-value" id="mafVal">0 g/s</div></div>
        <div class="metric-box"><div class="metric-label">Engine Load</div><div class="metric-value" id="loadVal">0%</div></div>
        <div class="metric-box"><div class="metric-label">Ignition Timing</div><div class="metric-value" id="timingVal">0°</div></div>
        <div class="metric-box"><div class="metric-label">Voltage</div><div class="metric-value" id="voltageVal">12V</div></div>

        <div class="metric-box"><div class="metric-label">STFT</div><div class="metric-value" id="stftVal">0%</div></div>
        <div class="metric-box"><div class="metric-label">LTFT</div><div class="metric-value" id="ltftVal">0%</div></div>
        <div class="metric-box"><div class="metric-label">Oil Pressure</div><div class="metric-value" id="oilPressureVal">0 PSI</div>
          <div class="hbar"><div class="fill" id="oilPressureBar"></div></div>
        </div>

        <div class="metric-box"><div class="metric-label">Ethanol % (E85)</div><div class="metric-value" id="e85Val">0%</div></div>
      </div>

      <div style="margin-top:6px;font-size:13px;color:var(--muted)">Quick Graphs</div>
      <div class="small-graphs" id="smallGraphs">
        <div class="graph-col">
          <div style="font-size:13px;margin-bottom:8px;color:var(--muted)">Fuel Level</div>
          <div class="graph-bar" style="height:180px;">
            <div class="graph-fill" id="fuelFill" style="height:30%"></div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--muted)"><span id="fuelPct">30%</span></div>
        </div>

        <div class="graph-col">
          <div style="font-size:13px;margin-bottom:8px;color:var(--muted)">Car Temp</div>
          <div class="graph-bar" style="height:180px;">
            <div class="graph-fill" id="carTempFill" style="height:40%"></div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--muted)"><span id="carTempPct">40%</span></div>
        </div>

        <div class="graph-col">
          <div style="font-size:13px;margin-bottom:8px;color:var(--muted)">Oil Pressure</div>
          <div class="graph-bar" style="height:180px;">
            <div class="graph-fill" id="opFill" style="height:30%"></div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--muted)"><span id="opPct">30%</span></div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div style="display:flex;gap:12px;align-items:center">
          <button class="record-btn" id="recordLeft">● Record</button>
          <button class="record-btn" id="recordRight">End ●</button>
          <a id="downloadCsv" class="download-link" style="display:none">Download CSV</a>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:13px">
          <div>Mode: <span id="activeDrive">Comfort</span></div>
          <div>Boost Mode: <span id="activeBoost">LOW</span></div>
        </div>
      </div>

      <div class="modules">
        <div class="gforce">
          <div style="font-size:12px;color:var(--muted)">G-Force</div>
          <div class="g-dot" id="gDot"></div>
        </div>

        <div class="tire-grid" id="tireTemps">
          <div class="tire-box" id="tFL">FL 0°C</div>
          <div class="tire-box" id="tFR">FR 0°C</div>
          <div class="tire-box" id="tRL">RL 0°C</div>
          <div class="tire-box" id="tRR">RR 0°C</div>
        </div>

        <div style="margin-left:auto">
          <div style="font-size:12px;color:var(--muted)">Brake</div>
          <div class="brake-dot" id="brakeDot"></div>
        </div>
      </div>

    </div>
  </div>

  <div class="map-popup" id="mapPopup">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div style="font-weight:800">Track Map</div>
      <div><button class="toggle-btn" id="closeMap">Close</button></div>
    </div>
    <div style="width:100%;height:180px;border-radius:8px;background:linear-gradient(90deg,#001020,#001220);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.12)">MAP MOCK</div>
    <div style="display:flex;justify-content:space-between;margin-top:8px">
      <div>Lap: <strong id="lapTime">0:00.000</strong></div>
      <div>Best: <strong id="bestLap">--:--.---</strong></div>
    </div>
  </div>

</div>

<script>
/* -------------------------
   Element bindings
   ------------------------- */
const rpmVal = document.getElementById('rpmVal');
const arc = document.getElementById('arc');
const arcBg = document.getElementById('arcBg');
const ticksGroup = document.getElementById('ticks');
const needleGroup = document.getElementById('needleGroup');
const needle = document.getElementById('needle');
const shiftLights = Array.from(document.querySelectorAll('.shift-light'));
const speedVal = document.getElementById('speedVal');
const kph = document.getElementById('kph');
const boostVal = document.getElementById('boostVal');
const boostBar = document.getElementById('boostBar');
const throttleVal = document.getElementById('throttleVal');
const throttleBar = document.getElementById('throttleBar');
const coolantVal = document.getElementById('coolantVal');
const oilTempVal = document.getElementById('oilTempVal');
const iatVal = document.getElementById('iatVal');
const mafVal = document.getElementById('mafVal');
const afrVal = document.getElementById('afrVal');
const loadVal = document.getElementById('loadVal');
const timingVal = document.getElementById('timingVal');
const voltageVal = document.getElementById('voltageVal');
const stftVal = document.getElementById('stftVal');
const ltftVal = document.getElementById('ltftVal');
const oilPressureVal = document.getElementById('oilPressureVal');
const oilPressureBar = document.getElementById('oilPressureBar');
const e85Val = document.getElementById('e85Val');
const gearVal = document.getElementById('gearVal');

const fuelFill = document.getElementById('fuelFill');
const fuelPct = document.getElementById('fuelPct');
const carTempFill = document.getElementById('carTempFill');
const carTempPct = document.getElementById('carTempPct');
const opFill = document.getElementById('opFill');
const opPct = document.getElementById('opPct');

const driveTiles = document.querySelectorAll('.tile');
const activeDriveLabel = document.getElementById('activeDrive');

const lowBoostBtn = document.getElementById('lowBoost');
const highBoostBtn = document.getElementById('highBoost');
const antilagBtn = document.getElementById('antilagBtn');
const activeBoostLabel = document.getElementById('activeBoost');

const nightToggle = document.getElementById('nightToggle');
const trackToggle = document.getElementById('trackToggle');
const driftToggle = document.getElementById('driftToggle');
const mapPopup = document.getElementById('mapPopup');
const mapToggle = document.getElementById('trackToggle'); // use trackToggle to show map on track on

const startLog = document.getElementById('startLog');
const endLog = document.getElementById('endLog');
const logList = document.getElementById('logList');
const recordLeft = document.getElementById('recordLeft');
const recordRight = document.getElementById('recordRight');
const downloadCsv = document.getElementById('downloadCsv');
const sessionState = document.getElementById('sessionState');
const recLeft = document.getElementById('recordLeft');
const recRight = document.getElementById('recordRight');

const gDot = document.getElementById('gDot');
const tFL = document.getElementById('tFL');
const tFR = document.getElementById('tFR');
const tRL = document.getElementById('tRL');
const tRR = document.getElementById('tRR');
const brakeDot = document.getElementById('brakeDot');

const startup = document.getElementById('startup');
setTimeout(()=> startup.style.display='none', 2400);

/* -------------------------
   Gauge drawing helpers
   ------------------------- */
const cx = 260, cy = 260, r = 200;
const startAngle = -180, endAngle = 0;
function polar(cx,cy,r,deg){
  const a = (deg-90)*Math.PI/180;
  return {x: cx + r*Math.cos(a), y: cy + r*Math.sin(a)};
}
function describeArc(cx,cy,r,startDeg,endDeg){
  const s = polar(cx,cy,r,endDeg); const e = polar(cx,cy,r,startDeg);
  const laf = (endDeg-startDeg)<=180?0:1;
  return `M ${s.x} ${s.y} A ${r} ${r} 0 ${laf} 0 ${e.x} ${e.y}`;
}
arcBg.setAttribute('d', describeArc(cx,cy,r,startAngle,endAngle));
arc.setAttribute('d', describeArc(cx,cy,r,startAngle,startAngle)); // start empty

// ticks (every 500rpm)
function drawTicks(){
  ticksGroup.innerHTML = '';
  const max=7000; const step=500;
  for(let v=0; v<=max; v+=step){
    const pct = v/max; const angle = startAngle + pct*(endAngle-startAngle);
    const outer = polar(cx,cy,r,angle); const inner = polar(cx,cy,r-18,angle);
    const l = document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('x1',outer.x); l.setAttribute('y1',outer.y); l.setAttribute('x2',inner.x); l.setAttribute('y2',inner.y);
    l.setAttribute('stroke','rgba(255,255,255,0.06)'); l.setAttribute('stroke-width','2');
    ticksGroup.appendChild(l);
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    const txtPos = polar(cx,cy,r-36,angle);
    t.setAttribute('x',txtPos.x); t.setAttribute('y',txtPos.y); t.setAttribute('font-size','10'); t.setAttribute('fill','rgba(255,255,255,0.6)'); t.setAttribute('text-anchor','middle');
    t.textContent = (v/1000)+'k';
    ticksGroup.appendChild(t);
  }
}
drawTicks();

/* -------------------------
   Simulation state and params
   ------------------------- */
let mode = 'comfort'; // comfort | sport | sportp
let boostMode = 'low'; // low | high
let antilagActive = false;
let driftMode = false;
let trackMode = false;

function modeParams(m, isTrack, isDrift){
  // base params
  const base = { rpmMul:0.6, throttleJit:6, boostMax:8, fuelUse:0.02, tempRamp:0.02, shiftSpeed:0.12 };
  if(m==='comfort') Object.assign(base,{rpmMul:0.6, throttleJit:6});
  if(m==='sport') Object.assign(base,{rpmMul:0.85, throttleJit:12});
  if(m==='sportp') Object.assign(base,{rpmMul:1.0, throttleJit:18});
  if(isTrack){ base.tempRamp*=2.5; base.shiftSpeed*=1.7; base.boostMax*=1.25; base.fuelUse*=1.6; }
  if(isDrift){ base.throttleJit*=2.2; base.rpmMul*=0.95; base.boostMax*=1.1; }
  return base;
}

let sim = {
  rpm: 900, speed:0, boost:-2, throttle:6, coolant:88, oilTemp:90, iat:22,
  maf:12.3, afr:14.7, load:12, timing:3, voltage:12.6, stft:0, ltft:0, oilPress:28, e85:52,
  fuel: 62, carTempPct: 32,
  // extra
  gX:0, gY:0,
  tireFL:70, tireFR:70, tireRL:68, tireRR:69,
  brakeTemp:40
};

/* -------------------------
   Logging
   ------------------------- */
let logging=false; let currentLog=[]; let sessions=[];

function appendLogRow(obj){ currentLog.push(obj); updateLogList(); }
function updateLogList(){
  if(currentLog.length===0){ logList.innerText='No logs yet.'; return; }
  logList.innerHTML = currentLog.slice(-12).map(r=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:12px">${r.t} | RPM:${r.rpm} | SPD:${r.speed} | Boost:${r.boost} | TH:${r.throttle}%</div>`).join('');
}

/* start/end log handlers */
startLog.addEventListener('click', ()=>{ logging=true; startLog.disabled=true; endLog.disabled=false; startLog.classList.add('rec'); sessionState.innerText='Logging'; currentLog=[]; downloadCsv.style.display='none'; });
endLog.addEventListener('click', ()=>{ logging=false; startLog.disabled=false; endLog.disabled=true; startLog.classList.remove('rec'); sessionState.innerText='Idle'; if(currentLog.length>0){ sessions.push(currentLog.slice()); downloadCsv.style.display='inline'; downloadCsv.onclick = ()=> downloadCSV(currentLog); } updateLogList(); });
recordLeft.addEventListener('click', ()=> startLog.click());
recordRight.addEventListener('click', ()=> endLog.click());
function downloadCSV(data){ const header=Object.keys(data[0]).join(','); const rows=data.map(r=>Object.values(r).join(',')).join('\\n'); const csv=header+'\\n'+rows; const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); downloadCsv.href=url; downloadCsv.download=`eurodash_log_${Date.now()}.csv`; downloadCsv.click(); setTimeout(()=>URL.revokeObjectURL(url),2000); }

/* -------------------------
   UI interaction bindings
   ------------------------- */
driveTiles.forEach(t=>{
  t.addEventListener('click', ()=>{
    driveTiles.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    mode = t.dataset.mode;
    activeDriveLabel.innerText = t.querySelector('.name').innerText;
  });
});
lowBoostBtn.addEventListener('click', ()=>{ boostMode='low'; lowBoostBtn.classList.add('active'); highBoostBtn.classList.remove('active'); activeBoostLabel.innerText='LOW'; });
highBoostBtn.addEventListener('click', ()=>{ boostMode='high'; highBoostBtn.classList.add('active'); lowBoostBtn.classList.remove('active'); activeBoostLabel.innerText='HIGH'; });
antilagBtn.addEventListener('click', ()=>{ antilagActive = !antilagActive; antilagBtn.classList.toggle('active'); });
nightToggle.addEventListener('click', ()=>{ document.body.classList.toggle('night-mode'); nightToggle.classList.toggle('active'); });
trackToggle.addEventListener('click', ()=>{ trackMode = !trackMode; trackToggle.classList.toggle('active'); mapPopup.style.display = trackMode ? 'block' : 'none'; });
driftToggle.addEventListener('click', ()=>{ driftMode = !driftMode; driftToggle.classList.toggle('active'); });

/* keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  if(e.key==='b'){ boostMode = boostMode==='low'?'high':'low'; document.getElementById('activeBoost').innerText = boostMode.toUpperCase(); lowBoostBtn.classList.toggle('active'); highBoostBtn.classList.toggle('active'); }
  if(e.key==='a'){ antilagBtn.click(); }
  if(e.key==='m'){ trackToggle.click(); }
  if(e.key==='d'){ driftToggle.click(); }
});

/* -------------------------
   Simulation loop
   ------------------------- */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function rand(min,max){ return Math.random()*(max-min)+min; }

function updateSim(){
  const p = modeParams(mode, trackMode, driftMode);

  // target throttle: realistic smoothed waveform plus noise & drift spikes
  let wave = 30 + 20*Math.sin(Date.now()/1200) + 10*Math.sin(Date.now()/600);
  let modeBias = p.rpmMul * 40;
  let jitter = rand(-p.throttleJit, p.throttleJit);
  let targetThrottle = clamp(modeBias + wave + jitter + (driftMode ? rand(5,25) : 0), 0, 100);
  sim.throttle += (targetThrottle - sim.throttle) * 0.12 + rand(-1,1)*(driftMode?1.6:1);

  // RPM responds to throttle and speed with smoothing
  const rpmTarget = 800 + sim.throttle * (55 * p.rpmMul);
  sim.rpm += (rpmTarget - sim.rpm) * (0.14 * (trackMode?1.3:1)) + rand(-80,80)*(driftMode?1.2:1);

  // Gear detection helper: simulate quicker shifts in track mode
  const approximateSpeed = sim.rpm / 70;
  sim.speed += (approximateSpeed - sim.speed) * (0.08 * (trackMode?1.2:1)) + rand(-1,1)*(driftMode?1.5:1);

  // Boost base: higher in high boost; active boost switching in track mode
  let baseBoost = boostMode==='high' ? rand(8, p.boostMax) : rand(-6,6);
  if(trackMode && Math.random()<0.06) baseBoost += rand(4,10); // active boost surge occasionally
  if(antilagActive) baseBoost += rand(6,14);
  sim.boost += (baseBoost - sim.boost) * 0.18 + rand(-0.6,0.6);

  // temps & pressures rise faster in track mode
  sim.coolant += (rand(80,100) - sim.coolant) * 0.03 * p.tempRamp * (trackMode?1.6:1);
  sim.oilTemp += (rand(85,130) - sim.oilTemp) * 0.035 * p.tempRamp * (trackMode?1.5:1);
  sim.iat += (rand(18,55) - sim.iat) * 0.04;
  sim.maf = Math.max(0, sim.throttle * rand(0.9,1.7));
  // AFR changes more under drift
  sim.afr += (rand(11.5,15.0) - sim.afr) * (driftMode?0.06:0.03);
  sim.load = clamp(sim.throttle * rand(0.75,1.1), 0, 100);
  sim.timing += (rand(-3,25) - sim.timing) * 0.06;
  sim.voltage += (rand(11.5,14.6) - sim.voltage) * 0.02;
  sim.stft += (rand(-5,5) - sim.stft) * 0.05;
  sim.ltft += (rand(-5,5) - sim.ltft) * 0.04;
  sim.oilPress += (rand(22,80) - sim.oilPress) * 0.06;

  // e85 simulated slowly
  sim.e85 += (rand(45,85) - sim.e85) * 0.012;

  // fuel consumption higher in track mode
  sim.fuel = clamp(sim.fuel - p.fuelUse * (trackMode?0.22:0.05), 2, 100);

  // carTempPct derived from oilTemp
  sim.carTempPct += (sim.oilTemp/3 - sim.carTempPct) * 0.008 * p.tempRamp * (trackMode?1.6:1);

  // G-force simulation: smoother lateral + longitudinal pulses (drift shows spikes)
  sim.gX = clamp(Math.sin(Date.now()/500)*0.6 + (driftMode? (Math.sin(Date.now()/120)*1.2) : 0), -2, 2);
  sim.gY = clamp(Math.cos(Date.now()/430)*0.4 + (driftMode? (Math.cos(Date.now()/160)*0.9) : 0), -2, 2);

  // Tire temps slowly respond, higher under track/drift
  const tireBias = trackMode?18:4;
  sim.tireFL += (rand(70,120) - sim.tireFL) * 0.03 * (trackMode?1.4:1) + (driftMode? rand(0,4):0);
  sim.tireFR += (rand(70,120) - sim.tireFR) * 0.03 * (trackMode?1.4:1) + (driftMode? rand(0,4):0);
  sim.tireRL += (rand(66,118) - sim.tireRL) * 0.02 * (trackMode?1.3:1) + (driftMode? rand(0,5):0);
  sim.tireRR += (rand(66,118) - sim.tireRR) * 0.02 * (trackMode?1.3:1) + (driftMode? rand(0,5):0);

  // brake temp climbs with throttle and speed, higher on track
  sim.brakeTemp += ((sim.speed/4) - sim.brakeTemp) * 0.02 * (trackMode?1.6:1);

  // round values for display
  const rpm = Math.round(sim.rpm);
  const speed = Math.round(sim.speed);
  const boost = Math.round(sim.boost*10)/10;
  const throttle = Math.round(sim.throttle);
  const coolant = Math.round(sim.coolant);
  const oilTemp = Math.round(sim.oilTemp);
  const iat = Math.round(sim.iat);
  const maf = Math.round(sim.maf*10)/10;
  const afr = Math.round(sim.afr*10)/10;
  const load = Math.round(sim.load);
  const timing = Math.round(sim.timing);
  const voltage = Math.round(sim.voltage*10)/10;
  const stft = Math.round(sim.stft*10)/10;
  const ltft = Math.round(sim.ltft*10)/10;
  const oilPress = Math.round(sim.oilPress*10)/10;
  const e85 = Math.round(sim.e85);

  // update DOM
  rpmVal.innerText = rpm.toLocaleString();
  // arc percent -> set arc path
  const rpmPct = clamp(rpm/7000, 0, 1);
  const arcAngle = startAngle + rpmPct * (endAngle - startAngle);
  arc.setAttribute('d', describeArc(cx,cy,r,startAngle, arcAngle));

  // needle rotation
  const needleAngle = arcAngle; // direct mapping
  needleGroup.setAttribute('transform', `rotate(${needleAngle} ${cx} ${cy})`);

  // shift lights
  const slStart = 3500, slEnd = 6800;
  const slPct = clamp((rpm - slStart)/(slEnd - slStart), 0, 1);
  const lightsOn = Math.round(slPct * shiftLights.length);
  shiftLights.forEach((el,i)=> el.classList.toggle('on', i < lightsOn));

  speedVal.innerText = speed + ' MPH';
  kph.innerText = Math.round(speed * 1.609).toString();
  boostVal.innerText = (boost >= 0 ? '+' : '') + boost + ' PSI';
  boostBar.style.width = Math.max(0,Math.min(100, (boost + 10) / 40 * 100)) + '%';
  throttleVal.innerText = throttle + '%';
  throttleBar.style.width = throttle + '%';
  coolantVal.innerText = coolant + '°C';
  oilTempVal.innerText = oilTemp + '°C';
  iatVal.innerText = iat + '°C';
  mafVal.innerText = maf + ' g/s';
  afrVal.innerText = afr;
  loadVal.innerText = load + '%';
  timingVal.innerText = timing + '°';
  voltageVal.innerText = voltage + 'V';
  stftVal.innerText = stft + '%';
  ltftVal.innerText = ltft + '%';
  oilPressureVal.innerText = oilPress + ' PSI';
  oilPressureBar.style.width = Math.max(0,Math.min(100,(oilPress-10)/70*100)) + '%';
  e85Val.innerText = e85 + '%';

  // fuel & graphs
  const fuelH = clamp(sim.fuel, 0, 100);
  fuelFill.style.height = fuelH + '%';
  fuelPct.innerText = Math.round(fuelH) + '%';
  const carTempH = clamp(sim.carTempPct, 0, 100);
  carTempFill.style.height = carTempH + '%';
  carTempPct.innerText = Math.round(carTempH) + '%';
  const opH = Math.max(5, (oilPress/100)*100);
  opFill.style.height = opH + '%';
  opPct.innerText = Math.round(opH) + '%';

  // g-force dot movement
  const gx = clamp(sim.gX, -2, 2), gy = clamp(sim.gY, -2, 2);
  // map to 44px radius area from center (approx)
  const gRadius = 44;
  const dotX = 65 + gx * gRadius;
  const dotY = 65 - gy * gRadius;
  gDot.style.transform = `translate(${dotX - 65}px, ${dotY - 65}px)`;

  // tire temps
  tFL.innerText = 'FL ' + Math.round(sim.tireFL) + '°C';
  tFR.innerText = 'FR ' + Math.round(sim.tireFR) + '°C';
  tRL.innerText = 'RL ' + Math.round(sim.tireRL) + '°C';
  tRR.innerText = 'RR ' + Math.round(sim.tireRR) + '°C';
  // color mapping for tire boxes depending on temp
  [tFL,tFR,tRL,tRR].forEach((el, idx)=>{
    const temp = [sim.tireFL,sim.tireFR,sim.tireRL,sim.tireRR][idx];
    // map 60-120 -> green -> orange -> red
    const pct = clamp((temp-60)/60,0,1);
    const hue = 120 - pct*120; // 120 green to 0 red
    el.style.background = `linear-gradient(90deg,hsl(${hue} 80% 30%), #080808)`;
    el.style.color = '#fff';
  });

  // brake glow effect
  const brakeGlow = Math.min(1, (sim.brakeTemp-20)/160);
  brakeDot.style.boxShadow = `inset 0 -10px 30px rgba(255,${Math.round(200*(1-brakeGlow))},${Math.round(200*(1-brakeGlow))},0.25), 0 0 ${6+brakeGlow*30}px rgba(255,60,60,${0.18+brakeGlow*0.2})`;

  // gear detection using function
  const gear = detectGear(rpm, speed);
  gearVal.innerText = gear;

  // log row append if logging
  if(logging && Math.random() < 0.9){
    const t = new Date().toISOString();
    appendLogRow({t, rpm, speed, boost, throttle, coolant, oilTemp, e85});
  }
}

/* run at 10Hz */
setInterval(updateSim, 100);

/* seed initial UI states */
lowBoostBtn.classList.add('active');
document.getElementById('activeBoost').innerText='LOW';
document.getElementById('activeDrive').innerText='Comfort';

/* Clock */
function updateClock(){
  const d = new Date();
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const day = dayNames[d.getDay()];
  const dateStr = `${day} ${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
  document.getElementById('clock').innerText = dateStr;
}
setInterval(updateClock,1000);
updateClock();

/* expose applyTelemetry for real feed (WebSocket/bridge) */
function applyTelemetry(d){
  if(typeof d.rpm!=='undefined') sim.rpm = d.rpm;
  if(typeof d.speed!=='undefined') sim.speed = d.speed;
  if(typeof d.boost!=='undefined') sim.boost = d.boost;
  if(typeof d.throttle!=='undefined') sim.throttle = d.throttle;
  if(typeof d.coolant!=='undefined') sim.coolant = d.coolant;
  if(typeof d.oilTemp!=='undefined') sim.oilTemp = d.oilTemp;
  if(typeof d.afr!=='undefined') sim.afr = d.afr;
  if(typeof d.e85!=='undefined') sim.e85 = d.e85;
  if(typeof d.oilPress!=='undefined') sim.oilPress = d.oilPress;
  if(typeof d.fuel!=='undefined') sim.fuel = d.fuel;
  if(typeof d.cartemp!=='undefined') sim.carTempPct = d.cartemp;
}
window.applyTelemetry = applyTelemetry;

/* Basic WebSocket bridge example (commented for security) */
/*
function connectWS(url){
  const ws = new WebSocket(url);
  ws.onopen = ()=> console.log('ws open');
  ws.onmessage = (ev)=> {
    try{ const d = JSON.parse(ev.data); applyTelemetry(d); } catch(e){ console.warn('bad ws msg', e); }
  };
  ws.onclose = ()=> console.log('ws closed');
  return ws;
}
*/

/* small helper: describeArc used earlier in gauge */
function polar(cx,cy,r,deg){
  const a = (deg-90)*Math.PI/180;
  return {x: cx + r*Math.cos(a), y: cy + r*Math.sin(a)};
}
function describeArc(cx,cy,r,startDeg,endDeg){
  const s = polar(cx,cy,r,endDeg); const e = polar(cx,cy,r,startDeg);
  const laf = (endDeg-startDeg)<=180?0:1;
  return `M ${s.x} ${s.y} A ${r} ${r} 0 ${laf} 0 ${e.x} ${e.y}`;
}

/* ensure initial arc drawn */
arc.setAttribute('d', describeArc(cx,cy,r,startAngle,startAngle));

/* UI: map popup close */
document.getElementById('closeMap').addEventListener('click', ()=> { mapPopup.style.display = 'none'; trackToggle.classList.remove('active'); trackMode=false; });

/* quick start: enable low boost active */
document.getElementById('lowBoost').click();

</script>
</body>
</html>
